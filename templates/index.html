<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Answers</title>
    <meta name="description" content="RSS Answers – Ihr Portal für RSS Feeds und intelligente Informationssuche mittels RAG System.">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="/static/rssanswers.png" type="image/png">
    <style>
        /* Zusätzliche CSS-Regeln für die Live-Antwort-Box im Header */
        .live-answer-box {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            display: none;
            min-height: 50px;
            font-size: 1em;
            overflow-wrap: break-word;
            /* Gleiche Breite wie die Artikel-Box */
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
   <script>
    async function searchInformation(event) {
        if (event) event.preventDefault();
        const question = document.getElementById("search-input").value;
        // Zeige den kleinen Spinner neben der Suche
        document.getElementById("loading-indicator").style.display = "inline-block";
        // Zurücksetzen der Live-Antwort-Box
        const answerBox = document.getElementById("live-answer-box");
        answerBox.style.display = "none";
        answerBox.innerHTML = "";
        try {
            const response = await fetch("/search", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: question })
            });
            const data = await response.json();
            // Blende den kleinen Spinner aus
            document.getElementById("loading-indicator").style.display = "none";
            // Statt eines Typewriter-Effekts wird der HTML-Code direkt gesetzt:
            answerBox.style.display = "block";
            answerBox.innerHTML = data.answer;
        } catch (error) {
            document.getElementById("loading-indicator").style.display = "none";
            answerBox.style.display = "block";
            answerBox.innerHTML = "Fehler bei der Suche.";
        }
    }

        // Typewriter-Funktion: Fügt Zeichen für Zeichen den Text in das Element ein
        function typeWriter(element, text, i = 0) {
            if (i === 0) {
                // Beim ersten Zeichen wird die Box eingeblendet
                element.style.display = "block";
                element.innerHTML = "";
            }
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                setTimeout(function() {
                    typeWriter(element, text, i + 1);
                }, 50); // 50ms Verzögerung pro Zeichen – anpassbar
            }
        }

        // Initialisierung beim Laden der Seite
        document.addEventListener("DOMContentLoaded", function() {
            const searchInput = document.getElementById("search-input");
            searchInput.addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    searchInformation(event);
                }
            });
            // Positioniere das Alters-Panel dynamisch unterhalb des Headers
            const header = document.querySelector("header");
            const panel = document.querySelector(".article-age-overview");
            if (header && panel) {
                panel.style.top = (header.offsetHeight + 10) + "px";
            }
            // Initialisiere den Artikel-Alter Filter (falls vorhanden)
            initArticleAgeFilter();
        });

        function initArticleAgeFilter() {
            const articles = document.querySelectorAll(".article");
            // Verwende als Referenzzeit die Veröffentlichungszeit des obersten Artikels
            const firstArticle = document.querySelector(".article");
            const referenceTime = firstArticle ? new Date(firstArticle.getAttribute("data-published")) : new Date();
            // Zähle Kategorien: 0 Tage (1 Tag), 1 Tag, 2 Tage, 3 bis 6 Tage, 7+ Tage
            let count1 = 0, count2 = 0, count3 = 0, count3plus = 0, count7plus = 0;
            articles.forEach(article => {
                const pubDateStr = article.getAttribute("data-published");
                if (!pubDateStr) return;
                const pubDate = new Date(pubDateStr);
                // Alter relativ zur Referenzzeit (in ganzen Tagen)
                const diffTime = referenceTime - pubDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                article.dataset.age = diffDays;
                // Standard: Nur Artikel mit diffDays === 0 anzeigen
                if (diffDays === 0) {
                    article.style.display = "";
                    count1++;
                } else {
                    article.style.display = "none";
                }
                if (diffDays === 1) {
                    count2++;
                } else if (diffDays === 2) {
                    count3++;
                } else if (diffDays >= 3 && diffDays < 7) {
                    count3plus++;
                } else if (diffDays >= 7) {
                    count7plus++;
                }
            });
            // Update der Übersichtspunkte im Alters-Panel
            document.getElementById("count-1").innerText = count1;
            document.getElementById("count-2").innerText = count2;
            document.getElementById("count-3").innerText = count3;
            document.getElementById("count-3plus").innerText = count3plus;
            document.getElementById("count-7plus").innerText = count7plus;

            // Klick-Events zur Filterung der Artikel
            const overviewItems = document.querySelectorAll(".article-age-overview li");
            overviewItems.forEach(item => {
                item.addEventListener("click", function() {
                    overviewItems.forEach(i => i.classList.remove("active"));
                    this.classList.add("active");
                    const filter = this.getAttribute("data-filter");
                    articles.forEach(article => {
                        const age = parseInt(article.dataset.age);
                        let show = false;
                        if (filter === "1" && age === 0) {
                            show = true;
                        } else if (filter === "2" && age === 1) {
                            show = true;
                        } else if (filter === "3" && age === 2) {
                            show = true;
                        } else if (filter === "3+" && age >= 3 && age < 7) {
                            show = true;
                        } else if (filter === "7+" && age >= 7) {
                            show = true;
                        }
                        article.style.display = show ? "" : "none";
                    });
                });
            });
            // Setze den Standardfilter "1 Tag" als aktiv
            const defaultFilter = document.querySelector('.article-age-overview li[data-filter="1"]');
            if (defaultFilter) defaultFilter.classList.add("active");
        }
    </script>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="logo">
                <img src="/static/rssanswers.png" alt="RSS Answers Logo" style="height:40px; margin-right:10px;">
                <span class="logo-text">RSS Answers</span>
            </div>
        </div>
        <div class="header-search">
            <form onsubmit="searchInformation(event);">
                <input type="text" id="search-input" placeholder="Stellen Sie Ihre Frage an RSS Answers..." />
                <button type="submit">Suchen</button>
                <!-- Kleiner Lade-Indikator neben der Suche -->
                <span id="loading-indicator" class="small-spinner"></span>
            </form>
        </div>
        <!-- Live-Antwort-Box: Wird eingeblendet, sobald die Antwort geladen wird -->
        <div id="live-answer-box" class="live-answer-box">{{ answer|safe }}</div>

    </header>

    <!-- Fixiertes Panel für die Artikel-Alter-Übersicht -->
    <div class="article-age-overview">
        <h3>Artikel Alter</h3>
        <ul id="age-overview-list">
            <li data-filter="1">1 Tag (<span id="count-1">0</span>)</li>
            <li data-filter="2">2 Tage (<span id="count-2">0</span>)</li>
            <li data-filter="3">3 Tage (<span id="count-3">0</span>)</li>
            <li data-filter="3+">Mehr als 3 Tage (<span id="count-3plus">0</span>)</li>
            <li data-filter="7+">Mehr als 1 Woche (<span id="count-7plus">0</span>)</li>
        </ul>
    </div>

    <main>
        <div class="container">
            {% if top_articles %}
            <h2>Top Artikel von Heute</h2>
            {% for article in top_articles %}
            <details class="article" data-published="{{ article.published }}">
                <summary>
                    <div class="title">
                        <a href="{{ article.link }}" target="_blank">{{ article.title }}</a>
                    </div>
                    <div class="meta">
                        Veröffentlicht: {{ article.published }} | Thema: {{ article.topic }} | Wichtigkeit: {{ article.importance }}
                    </div>
                    <div class="preview-content">
                        {{ article.content | first_words }}
                    </div>
                </summary>
                <div class="full-content">
                    {{ article.content | truncatewords(500) }}
                </div>
            </details>
            {% endfor %}
            {% endif %}
            
            <h2>Heutige Artikel</h2>
            {% for article in articles %}
            <details class="article" data-published="{{ article.published }}">
                <summary>
                    <div class="title">
                        <a href="{{ article.link }}" target="_blank">{{ article.title }}</a>
                    </div>
                    <div class="meta">
                        Veröffentlicht: {{ article.published }} | Thema: {{ article.topic }} | Wichtigkeit: {{ article.importance }}
                    </div>
                    <div class="preview-content">
                        {{ article.content | first_words }}
                    </div>
                </summary>
                <div class="full-content">
                    {{ article.content | truncatewords(500) }}
                </div>
            </details>
            {% endfor %}
            <div class="load-more">
                <a href="?time_filter=3_days">Mehr Artikel der letzten 3 Tage</a> |
                <a href="?time_filter=7_days">Mehr Artikel der letzten 7 Tage</a> |
                <a href="?time_filter=14_days">Mehr Artikel der letzten 14 Tage</a>
            </div>
        </div>
    </main>
</body>
</html>
